<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –î–æ–º–æ–≤–æ–π</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="ri-home-5-line icon-logo"></i> –î–æ–º–æ–≤–æ–π</h2>
            </div>
            
            <ul class="sidebar-nav">
                <li><a href="dashboard.html"><i class="ri-dashboard-line nav-icon"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="users.html"><i class="ri-user-3-line nav-icon"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
                <li><a href="verification.html"><i class="ri-shield-check-line nav-icon"></i> –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</a></li>
                <li><a href="requests.html"><i class="ri-file-list-3-line nav-icon"></i> –ó–∞—è–≤–∫–∏</a></li>
                <li><a href="news.html"><i class="ri-newspaper-line nav-icon"></i> –ù–æ–≤–æ—Å—Ç–∏</a></li>
                <li><a href="notifications.html" class="active"><i class="ri-notification-3-line nav-icon"></i> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a></li>
            </ul>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">–ê</div>
                    <div class="user-details">
                        <div class="name" id="userName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                        <div class="role">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
                <button class="btn btn-secondary logout-btn" onclick="logout()" style="width: 100%">–í—ã–π—Ç–∏</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="topbar">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                <h1>Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h1>
                <div class="topbar-actions">
                    <button class="btn btn-primary" onclick="openSendNotificationModal()">+ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</button>
                </div>
            </div>

            <div class="content">
                <!-- –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                <div class="card">
                    <div class="card-header">
                        <h3>–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                            <span class="meta"><span id="notificationCount" class="count">0</span><span class="label">—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</span></span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                                        <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                                        <th>–¢–∏–ø</th>
                                        <th>–ê—É–¥–∏—Ç–æ—Ä–∏—è</th>
                                        <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="notificationsTable">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px;">
                                            <div class="loader"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="modal" id="sendNotificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2>
                <button class="modal-close" onclick="closeModal('sendNotificationModal')">&times;</button>
            </div>
            <form id="notificationForm">
                <div class="form-group">
                    <label for="notificationType">–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è *</label>
                    <select id="notificationType" required>
                        <option value="general">–û–±—â–µ–µ</option>
                        <option value="outage">–û—Ç–∫–ª—é—á–µ–Ω–∏–µ (–≤–æ–¥–∞, —Å–≤–µ—Ç, –æ—Ç–æ–ø–ª–µ–Ω–∏–µ)</option>
                        <option value="meeting">–°–æ–±—Ä–∞–Ω–∏–µ –∂–∏–ª—å—Ü–æ–≤</option>
                        <option value="announcement">–û–±—ä—è–≤–ª–µ–Ω–∏–µ</option>
                        <option value="emergency">–ê–≤–∞—Ä–∏–π–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="notificationTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                    <input type="text" id="notificationTitle" placeholder="–ü–ª–∞–Ω–æ–≤–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤–æ–¥—ã" required maxlength="100">
                    <small>–ú–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤</small>
                </div>
                
                <div class="form-group">
                    <label for="notificationMessage">–°–æ–æ–±—â–µ–Ω–∏–µ *</label>
                    <textarea id="notificationMessage" rows="6" placeholder="15 –¥–µ–∫–∞–±—Ä—è —Å 10:00 –¥–æ 14:00 –±—É–¥–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–∞ —Ö–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç." required maxlength="500"></textarea>
                    <small>–ú–∞–∫—Å–∏–º—É–º 500 —Å–∏–º–≤–æ–ª–æ–≤</small>
                </div>
                
                <div class="form-group">
                    <label for="notificationAudience">–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å *</label>
                    <select id="notificationAudience" required>
                        <option value="all">–í—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</option>
                        <option value="verified">–¢–æ–ª—å–∫–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º</option>
                    </select>
                </div>
                
                <div class="alert alert-info">
                    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, —É –∫–æ—Ç–æ—Ä—ã—Ö –≤–∫–ª—é—á–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞.
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('sendNotificationModal')">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="modal" id="viewNotificationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–î–µ—Ç–∞–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
                <button class="modal-close" onclick="closeModal('viewNotificationModal')">&times;</button>
            </div>
            <div id="notificationDetails"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewNotificationModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script src="../js/data.js"></script>
    <script>
        checkAuth();

        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('userAvatar').textContent = currentUser.fullName.charAt(0);
        }

        function loadNotifications() {
            const notifications = getNotifications().sort((a, b) => 
                new Date(b.sentAt) - new Date(a.sentAt)
            );
            
            const tbody = document.getElementById('notificationsTable');
            document.getElementById('notificationCount').textContent = notifications.length;
            
            if (notifications.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</td></tr>';
                return;
            }

            tbody.innerHTML = notifications.map(notif => `
                <tr>
                    <td>${formatDate(notif.sentAt)}</td>
                    <td>${escapeHtml(notif.title)}</td>
                    <td><span class="badge ${getNotificationTypeBadge(notif.type)}">${getNotificationTypeText(notif.type)}</span></td>
                    <td>${getAudienceText(notif.targetAudience)}</td>
                    <td>${escapeHtml(notif.senderName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')}</td>
                    <td>
                        <button class="btn btn-primary btn-icon" onclick="viewNotification('${notif.id}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                            <span>üîç</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getNotificationTypeText(type) {
            const map = {
                'general': '–û–±—â–µ–µ',
                'outage': '–û—Ç–∫–ª—é—á–µ–Ω–∏–µ',
                'meeting': '–°–æ–±—Ä–∞–Ω–∏–µ',
                'announcement': '–û–±—ä—è–≤–ª–µ–Ω–∏–µ',
                'emergency': '–ê–≤–∞—Ä–∏–π–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è'
            };
            return map[type] || type;
        }

        function getNotificationTypeBadge(type) {
            const map = {
                'general': 'badge-info',
                'outage': 'badge-warning',
                'meeting': 'badge-info',
                'announcement': 'badge-secondary',
                'emergency': 'badge-danger'
            };
            return map[type] || 'badge-secondary';
        }

        function getAudienceText(audience) {
            const map = {
                'all': '–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                'verified': '–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ',
                'specific': '–í—ã–±–æ—Ä–æ—á–Ω–æ'
            };
            return map[audience] || audience;
        }

        function openSendNotificationModal() {
            document.getElementById('notificationForm').reset();
            openModal('sendNotificationModal');
        }

        function viewNotification(notifId) {
            const notifications = getNotifications();
            const notif = notifications.find(n => n.id === notifId);
            if (!notif) return;

            document.getElementById('notificationDetails').innerHTML = `
                <div class="form-group">
                    <label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
                    <input type="text" value="${formatDate(notif.sentAt)}" readonly>
                </div>
                <div class="form-group">
                    <label>–¢–∏–ø</label>
                    <input type="text" value="${getNotificationTypeText(notif.type)}" readonly>
                </div>
                <div class="form-group">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" value="${escapeHtml(notif.title)}" readonly>
                </div>
                <div class="form-group">
                    <label>–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                    <textarea readonly rows="6">${escapeHtml(notif.message)}</textarea>
                </div>
                <div class="form-group">
                    <label>–ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
                    <input type="text" value="${getAudienceText(notif.targetAudience)}" readonly>
                </div>
                <div class="form-group">
                    <label>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</label>
                    <input type="text" value="${escapeHtml(notif.senderName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')}" readonly>
                </div>
            `;
            openModal('viewNotificationModal');
        }

        document.getElementById('notificationForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const notification = {
                type: document.getElementById('notificationType').value,
                title: document.getElementById('notificationTitle').value.trim(),
                message: document.getElementById('notificationMessage').value.trim(),
                targetAudience: document.getElementById('notificationAudience').value,
                sentBy: currentUser.id,
                senderName: currentUser.fullName
            };

            if (!notification.title || !notification.message) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }

            if (notification.title.length > 100) {
                showError('–ó–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            if (notification.message.length > 500) {
                showError('–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø—Ä–µ–≤—ã—à–∞—Ç—å 500 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            if (!confirmAction(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ "${notification.title}"?`)) {
                return;
            }

            saveNotification(notification);
            showSuccess('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            closeModal('sendNotificationModal');
            loadNotifications();
        });

        loadNotifications();
    </script>
</body>
</html>