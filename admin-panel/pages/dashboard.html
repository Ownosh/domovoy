<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–º–æ–≤–æ–π - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body>
    <div class="dashboard">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="ri-home-5-line icon-logo"></i> –î–æ–º–æ–≤–æ–π</h2>
            </div>
            
            <ul class="sidebar-nav">
                <li><a href="dashboard.html" class="active"><i class="ri-dashboard-line nav-icon"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="users.html"><i class="ri-user-3-line nav-icon"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
                <li><a href="verification.html"><i class="ri-shield-check-line nav-icon"></i> –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</a></li>
                <li><a href="requests.html"><i class="ri-file-list-3-line nav-icon"></i> –ó–∞—è–≤–∫–∏</a></li>
                <li><a href="news.html"><i class="ri-newspaper-line nav-icon"></i> –ù–æ–≤–æ—Å—Ç–∏</a></li>
                <li><a href="notifications.html"><i class="ri-notification-3-line nav-icon"></i> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a></li>
            </ul>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">–ê</div>
                    <div class="user-details">
                        <div class="name" id="userName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                        <div class="role">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
                <button class="btn btn-secondary logout-btn" onclick="logout()">
                    –í—ã–π—Ç–∏
                </button>
            </div>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="main-content">
            <div class="topbar">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
                <div class="topbar-actions">
                    <span id="currentDate"></span>
                </div>
            </div>

            <div class="content">
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="ri-user-3-line"></i></div>
                        <div class="stat-info">
                            <h3 id="totalUsers">0</h3>
                            <p>–í—Å–µ–≥–æ –∂–∏—Ç–µ–ª–µ–π</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="ri-shield-check-line"></i></div>
                        <div class="stat-info">
                            <h3 id="verifiedUsers">0</h3>
                            <p>–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="ri-file-list-3-line"></i></div>
                        <div class="stat-info">
                            <h3 id="newRequests">0</h3>
                            <p>–ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon purple"><i class="ri-time-line"></i></div>
                        <div class="stat-info">
                            <h3 id="pendingVerifications">0</h3>
                            <p>–û–∂–∏–¥–∞—é—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</p>
                        </div>
                    </div>
                </div>

                <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏ -->
                <div class="card">
                    <div class="card-header">
                        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏
                            <span class="meta"><span id="recentRequestsCount" class="count">0</span><span class="label">–∑–∞—è–≤–æ–∫</span></span>
                        </h3>
                        <a href="requests.html" class="btn btn-primary">–í—Å–µ –∑–∞—è–≤–∫–∏</a>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–ñ–∏—Ç–µ–ª—å</th>
                                        <th>–¢–µ–º–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="recentRequests">
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 40px;">
                                            <div class="loader"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- –û–∂–∏–¥–∞—é—â–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ -->
                <div class="card">
                    <div class="card-header">
                        <h3>–û–∂–∏–¥–∞—é—Ç –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é
                            <span class="meta"><span id="pendingVerificationsCount" class="count">0</span><span class="label">–æ–∂–∏–¥–∞—é—Ç</span></span>
                        </h3>
                        <a href="verification.html" class="btn btn-primary">–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</a>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–ñ–∏—Ç–µ–ª—å</th>
                                        <th>Email</th>
                                        <th>–ö–≤–∞—Ä—Ç–∏—Ä–∞</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingVerificationsList">
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 40px;">
                                            <div class="loader"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/utils.js"></script>
    <script src="../js/data.js"></script>
    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        checkAuth();

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('userAvatar').textContent = currentUser.fullName.charAt(0);
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã (—Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã –¥–ª—è –¥–Ω—è –Ω–µ–¥–µ–ª–∏ –∏ –º–µ—Å—è—Ü–∞)
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const rawDate = new Date().toLocaleDateString('ru-RU', dateOptions);
        // 
        // Use a Unicode-aware regex to capitalize the first Cyrillic letter
        // of each word. \b doesn't reliably detect boundaries for Cyrillic letters
        // in some browsers, so we match a non-letter or start followed by a Cyrillic.
        const capitalizeCyrillic = (s) => s.replace(/(^|[^–ê-–Ø–∞-—è–Å—ë])([–∞-—è—ë])/gu, (m, p, ch) => p + ch.toUpperCase());
        // –ü–æ—Å–ª–µ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–≤–µ–¥—ë–º –∞–±–±—Ä–µ–≤–∏–∞—Ç—É—Ä—É –≥–æ–¥–∞ –∫ —Å—Ç—Ä–æ—á–Ω–æ–º—É –≤–∏–¥—É ("–≥.")
        let capitalized = capitalizeCyrillic(rawDate);
        // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–≥–ª–∞–≤–Ω—É—é '–ì.' –Ω–∞ —Å—Ç—Ä–æ—á–Ω—É—é '–≥.' ‚Äî —É—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É—é—â–∏–π —Å–∏–º–≤–æ–ª
        capitalized = capitalized.replace(/(^|[^–ê-–Ø–∞-—è–Å—ë])–ì\./gu, (m, p1) => (p1 || '') + '–≥.');
        document.getElementById('currentDate').textContent = capitalized;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function loadStatistics() {
            const stats = getStatistics();
            document.getElementById('totalUsers').textContent = stats.totalUsers;
            document.getElementById('verifiedUsers').textContent = stats.verifiedUsers;
            document.getElementById('newRequests').textContent = stats.newRequests;
            document.getElementById('pendingVerifications').textContent = stats.pendingVerifications;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞—è–≤–æ–∫
        function loadRecentRequests() {
            const requests = getRequests().sort((a, b) => 
                new Date(b.createdAt) - new Date(a.createdAt)
            ).slice(0, 5);

            const tbody = document.getElementById('recentRequests');
            const recentCountEl = document.getElementById('recentRequestsCount');
            if (recentCountEl) recentCountEl.textContent = requests.length;
            
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">–ù–µ—Ç –∑–∞—è–≤–æ–∫</td></tr>';
                return;
            }

            tbody.innerHTML = requests.map(req => `
                <tr>
                    <td>${formatDateShort(req.createdAt)}</td>
                    <td>${escapeHtml(req.userName)}</td>
                    <td>${escapeHtml(req.subject)}</td>
                    <td><span class="badge ${getStatusBadgeClass(req.status)}">${getStatusText(req.status)}</span></td>
                    <td>
                        <a href="requests.html?id=${req.id}" class="btn btn-primary btn-icon" title="–û—Ç–∫—Ä—ã—Ç—å –∑–∞—è–≤–∫—É">
                            <span>üîç</span>
                        </a>
                    </td>
                </tr>
            `).join('');
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ–∂–∏–¥–∞—é—â–∏—Ö –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function loadPendingVerifications() {
            const users = getUsers().filter(u => 
                u.verification && u.verification.status === 'pending'
            ).sort((a, b) => 
                new Date(b.verification.submittedAt) - new Date(a.verification.submittedAt)
            ).slice(0, 5);

            const tbody = document.getElementById('pendingVerificationsList');
            const pendingCountEl = document.getElementById('pendingVerificationsCount');
            if (pendingCountEl) pendingCountEl.textContent = users.length;
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">–ù–µ—Ç –æ–∂–∏–¥–∞—é—â–∏—Ö –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${formatDateShort(user.verification.submittedAt)}</td>
                    <td>${escapeHtml(user.fullName)}</td>
                    <td>${escapeHtml(user.email)}</td>
                    <td>–∫–≤. ${escapeHtml(user.verification.apartmentNumber)}</td>
                    <td>
                        <a href="verification.html?id=${user.id}" class="btn btn-primary btn-icon" title="–û—Ç–∫—Ä—ã—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é">
                            <span>üîç</span>
                        </a>
                    </td>
                </tr>
            `).join('');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        loadStatistics();
        loadRecentRequests();
        loadPendingVerifications();
    </script>
</body>
</html>