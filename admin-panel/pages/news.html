<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ–≤–æ—Å—Ç–∏ - –î–æ–º–æ–≤–æ–π</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
</head>
<body>
    <div class="dashboard">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2><i class="ri-home-5-line icon-logo"></i> –î–æ–º–æ–≤–æ–π</h2>
            </div>
            
            <ul class="sidebar-nav">
                <li><a href="dashboard.html"><i class="ri-dashboard-line nav-icon"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="users.html"><i class="ri-user-3-line nav-icon"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
                <li><a href="verification.html"><i class="ri-shield-check-line nav-icon"></i> –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è</a></li>
                <li><a href="requests.html"><i class="ri-file-list-3-line nav-icon"></i> –ó–∞—è–≤–∫–∏</a></li>
                <li><a href="news.html" class="active"><i class="ri-newspaper-line nav-icon"></i> –ù–æ–≤–æ—Å—Ç–∏</a></li>
                <li><a href="notifications.html"><i class="ri-notification-3-line nav-icon"></i> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</a></li>
            </ul>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">–ê</div>
                    <div class="user-details">
                        <div class="name" id="userName">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                        <div class="role">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    </div>
                </div>
                <button class="btn btn-secondary logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="topbar">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
                <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç—è–º–∏</h1>
                <div class="topbar-actions">
                    <button class="btn btn-primary" onclick="openAddNewsModal()">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å</button>
                </div>
            </div>

            <div class="content">
                <!-- –§–∏–ª—å—Ç—Ä—ã -->
                <div class="filters">
                    <div class="filter-row">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É..." onkeyup="filterNews()">
                        </div>
                        
                        <div class="filter-group">
                            <label>–¢–∏–ø</label>
                            <select id="filterType" onchange="filterNews()">
                                <option value="">–í—Å–µ</option>
                                <option value="news">–ù–æ–≤–æ—Å—Ç—å</option>
                                <option value="announcement">–û–±—ä—è–≤–ª–µ–Ω–∏–µ</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label>–°—Ç–∞—Ç—É—Å</label>
                            <select id="filterStatus" onchange="filterNews()">
                                <option value="">–í—Å–µ</option>
                                <option value="published">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</option>
                                <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π -->
                <div class="card">
                    <div class="card-header">
                        <h3>–°–ø–∏—Å–æ–∫ –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
                            <span class="meta"><span id="newsCount" class="count">0</span><span class="label">–∑–∞–ø–∏—Å–µ–π</span></span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>–î–∞—Ç–∞</th>
                                        <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                                        <th>–¢–∏–ø</th>
                                        <th>–ê–≤—Ç–æ—Ä</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="newsTable">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: 40px;">
                                            <div class="loader"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="modal" id="newsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å</h2>
                <button class="modal-close" onclick="closeModal('newsModal')">&times;</button>
            </div>
            <form id="newsForm">
                <input type="hidden" id="newsId">
                
                <div class="form-group">
                    <label for="newsTitle">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                    <input type="text" id="newsTitle" required>
                </div>
                
                <div class="form-group">
                    <label for="newsType">–¢–∏–ø *</label>
                    <select id="newsType" required>
                        <option value="news">–ù–æ–≤–æ—Å—Ç—å</option>
                        <option value="announcement">–û–±—ä—è–≤–ª–µ–Ω–∏–µ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newsCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="newsCategory">
                        <option value="">–û–±—â–∞—è</option>
                        <option value="maintenance">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</option>
                        <option value="meeting">–°–æ–±—Ä–∞–Ω–∏—è</option>
                        <option value="payment">–ü–ª–∞—Ç–µ–∂–∏</option>
                        <option value="rules">–ü—Ä–∞–≤–∏–ª–∞ –∏ –Ω–æ—Ä–º—ã</option>
                        <option value="events">–°–æ–±—ã—Ç–∏—è</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newsContent">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ *</label>
                    <textarea id="newsContent" rows="8" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="newsPublished">–°—Ç–∞—Ç—É—Å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ *</label>
                    <select id="newsPublished" required>
                        <option value="true">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</option>
                        <option value="false">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newsModal')">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
    <div class="modal" id="viewNewsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="viewNewsTitle"></h2>
                <button class="modal-close" onclick="closeModal('viewNewsModal')">&times;</button>
            </div>
            <div id="viewNewsContent"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('viewNewsModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script src="../js/utils.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/data.js"></script>
    <script>
        checkAuth();

        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) {
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('userAvatar').textContent = currentUser.fullName.charAt(0);
        }

        let allNews = [];

        async function loadNews() {
            try {
                allNews = await getNews();
                allNews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                displayNews(allNews);
            } catch (error) {
                console.error('Failed to load news:', error);
                allNews = [];
                displayNews([]);
            }
        }

        function displayNews(newsArray) {
            const tbody = document.getElementById('newsTable');
            document.getElementById('newsCount').textContent = newsArray.length;
            
            if (newsArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">–ù–æ–≤–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                return;
            }

            tbody.innerHTML = newsArray.map(item => `
                <tr>
                    <td>${formatDateShort(item.createdAt)}</td>
                    <td>${escapeHtml(item.title)}</td>
                    <td><span class="badge ${item.type === 'news' ? 'badge-info' : 'badge-warning'}">${item.type === 'news' ? '–ù–æ–≤–æ—Å—Ç—å' : '–û–±—ä—è–≤–ª–µ–Ω–∏–µ'}</span></td>
                    <td>${escapeHtml(item.authorName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')}</td>
                    <td><span class="badge ${item.isPublished ? 'badge-success' : 'badge-secondary'}">${item.isPublished ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫'}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-icon" onclick="viewNews('${item.id}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                <span>üîç</span>
                            </button>
                            <button class="btn btn-warning btn-icon" onclick="editNews('${item.id}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                <span>‚úèÔ∏è</span>
                            </button>
                            <button class="btn btn-danger btn-icon" onclick="deleteNewsItem('${item.id}')" title="–£–¥–∞–ª–∏—Ç—å">
                                <span>üóëÔ∏è</span>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterNews() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const statusFilter = document.getElementById('filterStatus').value;

            let filtered = allNews;

            if (searchTerm) {
                filtered = filtered.filter(item => 
                    item.title.toLowerCase().includes(searchTerm) ||
                    item.content.toLowerCase().includes(searchTerm)
                );
            }

            if (typeFilter) {
                filtered = filtered.filter(item => item.type === typeFilter);
            }

            if (statusFilter) {
                const isPublished = statusFilter === 'published';
                filtered = filtered.filter(item => item.isPublished === isPublished);
            }

            displayNews(filtered);
        }

        function openAddNewsModal() {
            document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å';
            document.getElementById('newsForm').reset();
            document.getElementById('newsId').value = '';
            document.getElementById('newsPublished').value = 'true';
            document.getElementById('newsCategory').value = '';
            openModal('newsModal');
        }

        async function viewNews(newsId) {
            const news = await getNewsById(newsId);
            if (!news) return;

            document.getElementById('viewNewsTitle').textContent = news.title;
            document.getElementById('viewNewsContent').innerHTML = `
                <div class="form-group">
                    <label>–¢–∏–ø</label>
                    <input type="text" value="${news.type === 'news' ? '–ù–æ–≤–æ—Å—Ç—å' : '–û–±—ä—è–≤–ª–µ–Ω–∏–µ'}" readonly>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
                    <input type="text" value="${formatDate(news.createdAt)}" readonly>
                </div>
                <div class="form-group">
                    <label>–ê–≤—Ç–æ—Ä</label>
                    <input type="text" value="${escapeHtml(news.authorName || '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä')}" readonly>
                </div>
                <div class="form-group">
                    <label>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                    <textarea readonly rows="10">${escapeHtml(news.content)}</textarea>
                </div>
            `;
            openModal('viewNewsModal');
        }

        async function editNews(newsId) {
            const news = await getNewsById(newsId);
            if (!news) return;

            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å';
            document.getElementById('newsId').value = news.id;
            document.getElementById('newsTitle').value = news.title;
            document.getElementById('newsType').value = news.type;
            document.getElementById('newsCategory').value = news.category || '';
            document.getElementById('newsContent').value = news.content;
            document.getElementById('newsPublished').value = news.isPublished ? 'true' : 'false';
            openModal('newsModal');
        }

        async function deleteNewsItem(newsId) {
            const news = await getNewsById(newsId);
            if (!news) return;

            if (confirmAction(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "${news.title}"?`)) {
                try {
                    await deleteNews(newsId);
                    showSuccess('–ù–æ–≤–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞');
                    await loadNews();
                } catch (error) {
                    showError('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å');
                }
            }
        }

        document.getElementById('newsForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newsId = document.getElementById('newsId').value;
            const newsData = {
                id: newsId || undefined,
                title: document.getElementById('newsTitle').value.trim(),
                type: document.getElementById('newsType').value,
                category: document.getElementById('newsCategory').value || undefined,
                content: document.getElementById('newsContent').value.trim(),
                isPublished: document.getElementById('newsPublished').value === 'true',
                authorId: currentUser.id || currentUser.userId,
                authorName: currentUser.fullName
            };

            if (!newsData.title || !newsData.content) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }

            try {
                await saveNews(newsData);
                showSuccess(newsId ? '–ù–æ–≤–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞' : '–ù–æ–≤–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞');
                closeModal('newsModal');
                await loadNews();
            } catch (error) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å');
            }
        });

        (async () => {
            await loadNews();
        })();
    </script>
</body>
</html>